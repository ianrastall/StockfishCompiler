name: Build Windows App

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "*" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed to read the latest tag

      - name: Determine Version from Tag
        id: version
        shell: pwsh
        run: |
          # 1. Try to get the tag, default to 1.2.0 if none exists
          $tag = git describe --tags --abbrev=0 2>$null
          if ([string]::IsNullOrWhiteSpace($tag)) { 
            Write-Host "No tags found. Defaulting to 1.2.0"
            $tag = "1.2.0" 
          }

          # 2. Remove 'v' prefix if present (v1.0 -> 1.0)
          if ($tag.StartsWith("v")) { $tag = $tag.Substring(1) }

          # 3. Create a "Clean" version for Windows (Must be numbers only!)
          # This strips off "-beta", "-alpha", etc.
          $cleanVer = $tag.Split('-')[0]

          # 4. Split into parts and ensure we have 4 numbers (x.y.z.w)
          $parts = $cleanVer.Split('.')
          [System.Collections.ArrayList]$verParts = $parts
          while ($verParts.Count -lt 4) { $verParts.Add("0") }
          
          # Join them back together (e.g., 1.2 -> 1.2.0.0)
          $assemblyVersion = $verParts -join '.'

          # 5. Output results
          Write-Host "Detected Display Version: $tag"
          Write-Host "Detected Assembly Version: $assemblyVersion"
          
          # Use the new GITHUB_OUTPUT syntax
          "version=$tag" >> $env:GITHUB_OUTPUT
          "assemblyVersion=$assemblyVersion" >> $env:GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' # Adjust if you are using .NET 6 or 7

      - name: Publish Single File Exe
        run: dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:Version=${{ steps.version.outputs.version }} -p:NuGetVersion=${{ steps.version.outputs.version }} -p:FileVersion=${{ steps.version.outputs.assemblyVersion }} -p:AssemblyVersion=${{ steps.version.outputs.assemblyVersion }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StockfishCompiler-Exe
          # This wildcard finds the .exe inside the specific publish folder
          # regardless of your specific .NET version number.
          path: '**/bin/Release/**/publish/*.exe'
          if-no-files-found: error